jQuery(function ($) {
  const POLL_DELAY_MS = 3e4,
    POLL_INTERVAL_MS = 3e3,
    ALLOWED_ORIGINS = (wc_cepta_params.allowed_origins || "")
      .split(",")
      .map((s) => s.trim())
      .filter(Boolean),
    ENFORCE_ORIGINS = ALLOWED_ORIGINS.length > 0;
  let delayTimeoutId = null,
    pollIntervalId = null,
    pollStarted = false,
    userClosed = false,
    callbackFired = false,
    activeRef = null,
    initFired = false;
  function showLoading() {
    if ($("#loading-spinner").length) return;
    $("body").append(
      "<style>.spinner-overlay{position:fixed;inset:0;background:rgba(255,255,255,.8);display:flex;justify-content:center;align-items:center;z-index:9999}.spinner{border:4px solid rgba(0,0,0,.1);border-top:4px solid #3498db;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}</style>" +
        '<div id="loading-spinner" class="spinner-overlay"><div class="spinner"></div></div>'
    );
    $("#wc-cepta-form").hide();
  }
  function hideLoading() {
    $("#loading-spinner").remove();
  }
  function modal(e, t) {
    $(".modal-overlay").remove();
    const n =
      "<style>.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;justify-content:center;align-items:center;z-index:10000}.cepta-modal{background:#fff;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,.3);max-width:420px;width:92%}.modal-content{padding:20px;text-align:center}.modal-footer{padding:10px 20px 20px;display:flex;justify-content:flex-end}.btn-primary{background:#3498db;color:#fff;border:none;padding:10px 20px;border-radius:4px;cursor:pointer}</style>" +
      `<div class="modal-overlay"><div class="cepta-modal"><div class="modal-content"><p>${e}</p></div><div class="modal-footer"><button type="button" class="btn btn-primary" id="okButton">OK</button></div></div></div>`;
    $("body").append(n);
    $("#okButton").on("click", () => {
      window.location.href = t;
    });
  }
  function $payBtn() {
    return $("#cepta-payment-button");
  }
  function setButtonLoading() {
    const e = $payBtn();
    if (!e.length) return;
    e.data("orig-text") || e.data("orig-text", $.trim(e.text())),
      e.data("locked-width") ||
        (e.css("width", e.outerWidth() + "px"), e.data("locked-width", !0)),
      e.data("orig-pointer-events") ||
        e.data("orig-pointer-events", e.css("pointer-events") || ""),
      e.css("pointer-events", "none"),
      e.text("WAITâ€¦");
  }
  function clearButtonLoading() {
    const e = $payBtn();
    if (!e.length) return;
    const t = e.data("orig-text");
    e.text(t || "Pay Now");
    const n = e.data("orig-pointer-events");
    e.css("pointer-events", n || ""),
      e.removeData("orig-pointer-events"),
      e.data("locked-width") &&
        (e.css("width", ""), e.removeData("locked-width"));
  }
  function stopDelay() {
    delayTimeoutId && (clearTimeout(delayTimeoutId), (delayTimeoutId = null));
  }
  function stopPolling() {
    pollIntervalId && (clearInterval(pollIntervalId), (pollIntervalId = null)),
      stopDelay(),
      (pollStarted = !1);
  }
  function postTarget() {
    return window.parent && window.parent !== window
      ? window.parent
      : window.opener && !window.opener.closed
      ? window.opener
      : window.top || window;
  }
  function broadcast(e, t) {
    const n = { event: e, transactionRef: t || activeRef },
      o = postTarget();
    try {
      o.postMessage(n, "*"), o.postMessage(JSON.stringify(n), "*");
    } catch {}
  }
  function closeSdk(e) {
    try {
      window.CeptaPay?.closeModal && window.CeptaPay.closeModal(e || "close"),
        console.warn("[CeptaPay] CLOSE IFRAME MODAL.");
    } catch {}
  }
  function fireOnce(e, t) {
    if (callbackFired) return;
    (callbackFired = !0),
      stopPolling(),
      closeSdk(e),
      "success" !== e && "failed" !== e && "close" !== e
        ? broadcast(e, t)
        : broadcast(e, t);
  }
  function verifyTransaction(e) {
    const t = e || activeRef;
    if (!t)
      return console.warn("[CeptaPay] verifyTransaction called without ref.");
    showLoading();
    $.ajax({
      url: "/wc-api/wc_gateway_cepta_popup",
      method: "POST",
      dataType: "json",
      data: {
        transactionRef: t,
        ceptaOderId: wc_cepta_params.meta_order_id,
        wc_cepta_payment_nonce: wc_cepta_params.nonce,
      },
      success: function (e) {
        const t =
          !0 === e.statusRes && e.redirect
            ? e.redirect
            : wc_cepta_params.checkout_url || window.location.href;
        window.location.href = t;
      },
      error: function (e, t, n) {
        console.error("Verification AJAX Error:", t, n),
          modal(
            "An unexpected error occurred during verification. Please contact support.",
            wc_cepta_params.checkout_url || window.location.href
          );
      },
      complete: hideLoading,
    });
  }
  function restorePayNow() {
    $("#wc-cepta-form").show(),
      $("form#payment-form, form#order_review")
        .find("input.cepta_txnref")
        .val(""),
      $("#cepta-payment-button")
        .off("click")
        .on("click", function (e) {
          e.preventDefault(),
            setButtonLoading(),
            handlePayment({ fromClick: !0 });
        }),
      $("form.checkout, form#order_review")
        .find('button, input[type="submit"]')
        .prop("disabled", !0)
        .show();
  }
  function startPolling(e) {
    if (!e || pollStarted) return;
    if (!window.CeptaPay?.confirmStatus)
      return console.warn(
        "[CeptaPay] confirmStatus not available; skipping poll."
      );
    (userClosed = !1),
      (callbackFired = !1),
      (pollStarted = !0),
      (activeRef = e),
      (delayTimeoutId = setTimeout(function () {
        if (userClosed) return void stopPolling();
        pollIntervalId = setInterval(async function () {
          if (userClosed) return void stopPolling();
          try {
            const t = await window.CeptaPay.confirmStatus(e);
            if (!t?.status) return;
            const n = t.data;
            if (!n) return;
            const o = n.transactionReference,
              a = parseFloat(n.amount || 0);
            if (!o || !(a > 0)) return;
            "Successful" === n.status
              ? fireOnce("success", e)
              : "Failed" === n.status && fireOnce("failed", e);
          } catch (t) {
            console.error("[CeptaPay] Polling error:", t),
              $("#wc-cepta-form").show(),
              fireOnce("close", e);
          }
        }, POLL_INTERVAL_MS);
      }, POLL_DELAY_MS));
  }
  function onSuccess(e) {
    clearButtonLoading(), verifyTransaction(e);
  }
  function onFailed(e) {
    console.error("Error during payment processing:", e),
      clearButtonLoading(),
      verifyTransaction(e);
  }
  function onClose(e) {
    (userClosed = !0), clearButtonLoading();
    try {
      window.CeptaPay?.closeModal();
    } catch {}
  }
  function getUrlRef() {
    const e = new URLSearchParams(window.location.search);
    if (e.get("ref")) return e.get("ref");
    const t = window.location.href.lastIndexOf("?");
    if (-1 === t) return null;
    for (const e of window.location.href.substring(t + 1).split("&")) {
      const [t, n] = e.split("=");
      if ("ref" === t) return n;
    }
    return null;
  }
  async function handlePayment(e = { fromClick: !1 }) {
    $("#wc-cepta-form").show(),
      $("form#payment-form, form#order_review")
        .find("input.cepta_txnref")
        .val("");
    const t = Number(wc_cepta_params.amount),
      n = "WC_" + Date.now();
    activeRef = n;
    const o = getUrlRef();
    if (o) return clearButtonLoading(), void broadcast("success", o);
    if (!window.CeptaPay?.checkout)
      return (
        console.error("CeptaPay SDK not loaded."),
        clearButtonLoading(),
        void onFailed(n)
      );
    const a = {
        amount: t,
        currency: wc_cepta_params.currency,
        description: "Payment for Order ID " + wc_cepta_params.meta_order_id,
        pageName: "",
        customerEmail: wc_cepta_params.email,
        transactionReference: n,
        customUrlText: "",
        callbackUrl:
          window.location.href +
          "&nonce=" +
          encodeURIComponent(wc_cepta_params.nonce),
        isPlugin: !0,
      },
      r = {
        publicKey: wc_cepta_params.public_key,
        secretKey: wc_cepta_params.secret_key,
        baseUrl: wc_cepta_params.base_url,
      };
    try {
      await window.CeptaPay.checkout({
        paymentData: a,
        config: r,
        onSuccess,
        onFailed,
        onClose,
      }),
        clearButtonLoading(),
        startPolling(n);
    } catch (e) {
      console.error("CeptaPay Checkout failed to launch:", e?.message),
        clearButtonLoading(),
        onFailed(n);
    }
  }
  window.addEventListener(
    "message",
    function (e) {
      if (ENFORCE_ORIGINS && !ALLOWED_ORIGINS.includes(e.origin)) return;
      let t = e.data;
      if ("string" == typeof t)
        try {
          t = JSON.parse(t);
        } catch {
          return;
        }
      if (!t?.event) return;
      const n = t.transactionRef || activeRef;
      switch (t.event) {
        case "success":
          onSuccess(n);
          break;
        case "failed":
          onFailed(n);
          break;
        case "close":
          onClose(n);
          break;
        default:
      }
    },
    !1
  ),
    window.addEventListener("beforeunload", stopPolling),
    $("form.checkout").on("checkout_place_order_cepta", function (e) {
      return e.preventDefault(), handlePayment({ fromClick: !1 }), !1;
    }),
    $("#order_review").on("submit", function (e) {
      if ($("#payment_method_cepta").is(":checked"))
        return e.preventDefault(), handlePayment({ fromClick: !1 }), !1;
    }),
    $("#cepta-payment-button").on("click", function (e) {
      return (
        e.preventDefault(),
        setButtonLoading(),
        handlePayment({ fromClick: !0 }),
        !1
      );
    }),
    $("#wc-cepta-form").hide(),
    initFired || ((initFired = !0), handlePayment({ fromClick: !1 })),
    "true" === String(wc_cepta_params.is_order_pay_page) &&
      !initFired &&
      ((initFired = !0), handlePayment({ fromClick: !1 })),
    restorePayNow();
});
