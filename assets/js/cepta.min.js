jQuery(function ($) {
  var POLL_DELAY_MS = 30000,
    POLL_INTERVAL_MS = 3000,
    ALLOWED_ORIGINS = (wc_cepta_params.allowed_origins || "")
      .split(",")
      .filter(Boolean),
    ENFORCE_ORIGINS = ALLOWED_ORIGINS.length > 0,
    pollIntervalId = null,
    delayTimeoutId = null,
    pollStarted = false,
    userClosed = false,
    activeRef = null,
    callbackFired = false;
  function showLoadingSpinner() {
    if (!$("#loading-spinner").length) {
      $("body").append(
        '<style>.spinner-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,.8);display:flex;justify-content:center;align-items:center;z-index:9999}.spinner{border:4px solid rgba(0,0,0,.1);border-top:4px solid #3498db;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}</style><div id="loading-spinner" class="spinner-overlay"><div class="spinner"></div></div>'
      );
      $("#wc-cepta-form").show();
    }
  }
  function removeLoadingSpinner() {
    $("#loading-spinner").remove();
  }
  function displayModal(e, t) {
    $(".modal-overlay").remove();
    var n =
      '<style>.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;justify-content:center;align-items:center;z-index:10000}.cepta-modal-container{background:#fff;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,.3);position:relative;max-width:420px;width:92%;z-index:10001}.modal-content{padding:20px;text-align:center}.modal-footer{padding:10px 20px 20px;display:flex;justify-content:flex-end}.btn-primary{background:#3498db;color:#fff;border:none;padding:10px 20px;border-radius:4px;cursor:pointer}</style><div class="modal-overlay"><div class="cepta-modal-container"><div class="modal-content"><p>' +
      e +
      '</p></div><div class="modal-footer"><button type="button" class="btn btn-primary" id="okButton">OK</button></div></div></div>';
    $("body").append(n);
    $("#okButton").on("click", function () {
      window.location.href = t;
    });
  }
  function buildMetaData() {
    var e = [
      { display_name: "Plugin", variable_name: "plugin", value: "woo-cepta" },
    ];
    return (
      wc_cepta_params.meta_order_id &&
        e.push({
          display_name: "Order ID",
          variable_name: "order_id",
          value: wc_cepta_params.meta_order_id,
        }),
      wc_cepta_params.meta_name &&
        e.push({
          display_name: "Customer Name",
          variable_name: "customer_name",
          value: wc_cepta_params.meta_name,
        }),
      wc_cepta_params.meta_email &&
        e.push({
          display_name: "Customer Email",
          variable_name: "customer_email",
          value: wc_cepta_params.meta_email,
        }),
      wc_cepta_params.meta_phone &&
        e.push({
          display_name: "Customer Phone",
          variable_name: "customer_phone",
          value: wc_cepta_params.meta_phone,
        }),
      wc_cepta_params.meta_billing_address &&
        e.push({
          display_name: "Billing Address",
          variable_name: "billing_address",
          value: wc_cepta_params.meta_billing_address,
        }),
      wc_cepta_params.meta_shipping_address &&
        e.push({
          display_name: "Shipping Address",
          variable_name: "shipping_address",
          value: wc_cepta_params.meta_shipping_address,
        }),
      wc_cepta_params.meta_products &&
        e.push({
          display_name: "Products",
          variable_name: "products",
          value: wc_cepta_params.meta_products,
        }),
      e
    );
  }
  function buildChannelOptions() {
    var e = {};
    return (
      wc_cepta_params.card_channel &&
        (wc_cepta_params.banks_allowed &&
          (e.banks = wc_cepta_params.banks_allowed),
        wc_cepta_params.cards_allowed &&
          (e.card_brands = wc_cepta_params.cards_allowed)),
      e
    );
  }
  function buildAllowedChannels() {
    var e = [];
    return (
      wc_cepta_params.bank_channel && e.push("bank"),
      wc_cepta_params.card_channel && e.push("card"),
      wc_cepta_params.ussd_channel && e.push("ussd"),
      wc_cepta_params.qr_channel && e.push("qr"),
      wc_cepta_params.bank_transfer_channel && e.push("bank_transfer"),
      e
    );
  }
  function clearDelayCountdown() {
    delayTimeoutId && (clearTimeout(delayTimeoutId), (delayTimeoutId = null));
  }
  function clearPolling() {
    pollIntervalId && (clearInterval(pollIntervalId), (pollIntervalId = null)),
      clearDelayCountdown(),
      (pollStarted = false);
  }
  function getBestTargetWindow() {
    if (window.parent && window.parent !== window) return window.parent;
    if (window.opener && !window.opener.closed) return window.opener;
    return window.top ? window.top : window;
  }
  function safeStringify(e) {
    try {
      return JSON.stringify(e);
    } catch (e) {
      return "";
    }
  }
  function broadcastEvent(e, t) {
    var n = { event: e, transactionRef: t || activeRef },
      o = safeStringify(n),
      a = getBestTargetWindow();
    try {
      a.postMessage(n, "*"), a.postMessage(o, "*");
    } catch (e) {
      try {
        window.postMessage(n, "*"), window.postMessage(o, "*");
      } catch (e) {}
    }
  }
  function tryCloseModal(e) {
    try {
      window.CeptaPay &&
        "function" == typeof window.CeptaPay.closeModal &&
        window.CeptaPay.closeModal(e || "close"),
        console.warn("[CeptaPay] CLOSE IFRAME.");
    } catch (e) {}
  }
  function fireCloseOnError(e, t) {
    if (callbackFired) return;
    (callbackFired = true),
      clearPolling(),
      tryCloseModal(e),
      broadcastEvent(e, t),
      showPayNow(true);
  }
  function fireOnce(e, t) {
    if (callbackFired) return;
    (callbackFired = true),
      clearPolling(),
      tryCloseModal(e),
      "success" === e || "failed" === e
        ? broadcastEvent(e, t)
        : showPayNow(true);
  }
  function verifyTransaction(e) {
    e || (e = activeRef);
    if (!e) {
      console.warn("[CeptaPay] verifyTransaction called without ref.");
      return;
    }
    showLoadingSpinner();
    var t = wc_cepta_params.meta_order_id,
      n = wc_cepta_params.nonce,
      o = "/wc-api/wc_gateway_cepta_popup";
    $.ajax({
      url: o,
      method: "POST",
      data: { transactionRef: e, ceptaOderId: t, wc_cepta_payment_nonce: n },
      dataType: "json",
      success: function (e) {
        var n =
          true === e.statusRes && e.redirect
            ? e.redirect
            : wc_cepta_params.checkout_url || window.location.href;
        true === e.statusRes
          ? (window.location.href = n)
          : (window.location.href = n);
      },
      error: function (e, t, n) {
        console.error("Verification AJAX Error:", t, n),
          displayModal(
            "An unexpected error occurred during verification. Please contact support.",
            wc_cepta_params.checkout_url || window.location.href
          );
      },
      complete: function () {
        removeLoadingSpinner();
      },
    });
  }
  function initiateVerification(e) {
    broadcastEvent("success", e);
  }
  function startPolling(e) {
    if (!e) return;
    if (pollStarted) {
      console.log("[CeptaPay] Polling already started; ignoring.");
      return;
    }
    if (
      !window.CeptaPay ||
      "function" != typeof window.CeptaPay.confirmStatus
    ) {
      console.warn("[CeptaPay] confirmStatus not available; skipping poll.");
      return;
    }
    (userClosed = false),
      (callbackFired = false),
      (pollStarted = true),
      (activeRef = e),
      console.log(
        "[CeptaPay] Polling will begin in " +
          POLL_DELAY_MS / 1e3 +
          "s for ref:",
        e
      ),
      (delayTimeoutId = setTimeout(function () {
        if (userClosed) {
          console.log("[CeptaPay] Polling aborted: user closed during delay."),
            clearPolling();
          return;
        }
        console.log("[CeptaPay] Starting polling now…"),
          (pollIntervalId = setInterval(async function () {
            if (userClosed) {
              console.log("[CeptaPay] userClosed detected; stopping polling."),
                clearPolling();
              return;
            }
            try {
              const t = await window.CeptaPay.confirmStatus(e);
              if (
                (console.log("[CeptaPay] confirmStatus response:", t),
                !t || true !== t.status)
              )
                return;
              const n = t.data;
              if (!n) return;
              const o = n.transactionReference,
                a = parseFloat(n.amount || 0);
              if (!o || !(a > 0)) {
                console.warn(
                  `[CeptaPay] Incomplete snapshot txnRef=${o}, amount=${a} → retry`
                );
                return;
              }
              console.log("[CeptaPay DATA] confirmStatus DATA response:", t);
              const r = n.status;
              "Successful" === r
                ? (console.log(
                    "[CeptaPay] STATUS: SUCCESSFUL → stop poll & signal"
                  ),
                  fireOnce("success", e))
                : "Failed" === r &&
                  (console.log("[CeptaPay] Status=Failed → stop poll & signal"),
                  fireOnce("failed", e));
            } catch (t) {
              console.error("[CeptaPay] Polling error:", t),
                fireCloseOnError("close", e);
            }
          }, POLL_INTERVAL_MS));
      }, POLL_DELAY_MS));
  }
  function onSuccessHandler(e) {
    verifyTransaction(e), console.warn("[CeptaPay] VERIFICATION NEXT.", e);
  }
  function onFailedHandler(e) {
    verifyTransaction(e), console.error("Error during payment processing:", e);
  }
  function onCloseHandler(e) {
    (userClosed = true), window.CeptaPay.closeModal(), showPayNow(true);
  }
  async function handlePayment() {
    $("#wc-cepta-form").hide(),
      $("form#payment-form, form#order_review")
        .find("input.cepta_txnref")
        .val("");
    var e = Number(wc_cepta_params.amount),
      t = window.location.href,
      n = "WC_" + Date.now();
    activeRef = n;
    var o = {
        amount: e,
        currency: wc_cepta_params.currency,
        description: "Payment for Order ID " + wc_cepta_params.meta_order_id,
        pageName: "",
        customerEmail: wc_cepta_params.email,
        transactionReference: n,
        customUrlText: "",
        callbackUrl: t + "&nonce=" + encodeURIComponent(wc_cepta_params.nonce),
        isPlugin: true,
      },
      a = {
        publicKey: wc_cepta_params.public_key,
        secretKey: wc_cepta_params.secret_key,
        baseUrl: wc_cepta_params.base_url,
      },
      r = new URLSearchParams(window.location.search).get("ref");
    if (!r) {
      var i = t.lastIndexOf("?");
      if (-1 !== i) {
        for (var l = t.substring(i + 1).split("&"), s = 0; s < l.length; s++) {
          var c = l[s].split("=");
          if ("ref" === c[0]) {
            r = c[1];
            break;
          }
        }
      }
    }
    if (r) {
      console.log(
        "[CeptaPay] Found ref in URL; signaling parent to verify:",
        r
      ),
        broadcastEvent("success", r);
      return;
    }
    if (!window.CeptaPay || "function" != typeof window.CeptaPay.checkout) {
      console.error("CeptaPay SDK is not loaded. Cannot proceed with payment."),
        onFailedHandler(n);
      return;
    }
    try {
      await window.CeptaPay.checkout({
        paymentData: o,
        config: a,
        onSuccess: onSuccessHandler,
        onFailed: onFailedHandler,
        onClose: onCloseHandler,
      }),
        startPolling(n);
    } catch (e) {
      console.error("CeptaPay Checkout failed to launch:", e && e.message),
        onFailedHandler(n);
    }
  }
  window.addEventListener(
    "message",
    function (e) {
      if (ENFORCE_ORIGINS && -1 === ALLOWED_ORIGINS.indexOf(e.origin)) return;
      var t = e.data;
      if ("string" == typeof t)
        try {
          t = JSON.parse(t);
        } catch (e) {
          return;
        }
      if (!t || !t.event) return;
      var n = t.transactionRef || activeRef;
      switch (t.event) {
        case "success":
          console.log("Bridge: success event", t), onSuccessHandler(n);
          break;
        case "failed":
          console.log("Bridge: failed event", t), onFailedHandler(n);
          break;
        case "close":
          console.log("Bridge: close event", t), onCloseHandler(n);
          break;
        default:
      }
    },
    false
  ),
    window.addEventListener("beforeunload", function () {
      clearPolling();
    }),
    $("form.checkout").on("checkout_place_order_cepta", function (e) {
      e.preventDefault(), handlePayment();
      return false;
    }),
    $("#order_review").on("submit", function (e) {
      if ($("#payment_method_cepta").is(":checked")) {
        e.preventDefault(), handlePayment();
        return false;
      }
    }),
    $("#cepta-payment-button").on("click", function (e) {
      e.preventDefault(), handlePayment();
      return false;
    }),
    $("#wc-cepta-form").hide(),
    handlePayment(),
    "true" === String(wc_cepta_params.is_order_pay_page) && handlePayment();
});
