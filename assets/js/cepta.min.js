jQuery(function ($) {
  function a() {
    let a = [
      { display_name: "Plugin", variable_name: "plugin", value: "woo-cepta" },
    ];
    return (
      wc_cepta_params.meta_order_id &&
        a.push({
          display_name: "Order ID",
          variable_name: "order_id",
          value: wc_cepta_params.meta_order_id,
        }),
      wc_cepta_params.meta_name &&
        a.push({
          display_name: "Customer Name",
          variable_name: "customer_name",
          value: wc_cepta_params.meta_name,
        }),
      wc_cepta_params.meta_email &&
        a.push({
          display_name: "Customer Email",
          variable_name: "customer_email",
          value: wc_cepta_params.meta_email,
        }),
      wc_cepta_params.meta_phone &&
        a.push({
          display_name: "Customer Phone",
          variable_name: "customer_phone",
          value: wc_cepta_params.meta_phone,
        }),
      wc_cepta_params.meta_billing_address &&
        a.push({
          display_name: "Billing Address",
          variable_name: "billing_address",
          value: wc_cepta_params.meta_billing_address,
        }),
      wc_cepta_params.meta_shipping_address &&
        a.push({
          display_name: "Shipping Address",
          variable_name: "shipping_address",
          value: wc_cepta_params.meta_shipping_address,
        }),
      wc_cepta_params.meta_products &&
        a.push({
          display_name: "Products",
          variable_name: "products",
          value: wc_cepta_params.meta_products,
        }),
      a
    );
  }
  function b() {
    let a = {};
    return (
      wc_cepta_params.card_channel &&
        (wc_cepta_params.banks_allowed &&
          (a.banks = wc_cepta_params.banks_allowed),
        wc_cepta_params.cards_allowed &&
          (a.card_brands = wc_cepta_params.cards_allowed)),
      a
    );
  }
  function c() {
    let a = [];
    return (
      wc_cepta_params.bank_channel && a.push("bank"),
      wc_cepta_params.card_channel && a.push("card"),
      wc_cepta_params.ussd_channel && a.push("ussd"),
      wc_cepta_params.qr_channel && a.push("qr"),
      wc_cepta_params.bank_transfer_channel && a.push("bank_transfer"),
      a
    );
  }
  function d(a, b) {
    $(".modal-overlay").remove();
    const c = `<style>.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 10000; } .cepta-modal-container { background: #fff; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.3); position: relative; max-width: 400px; width: 90%; z-index: 10001; } .modal-content { padding: 20px; text-align: center; } .modal-footer { padding: 10px 20px 20px; display: flex; justify-content: flex-end; } .btn-primary { background-color: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }</style><div class="modal-overlay"><div class="cepta-modal-container"><div class="modal-content"><p>${a}</p></div><div class="modal-footer"><button type="button" class="btn btn-primary" id="okButton">OK</button></div></div></div>`;
    $("body").append(c),
      $("#okButton").on("click", function () {
        window.location.href = b;
      });
  }
  function e() {
    $("#loading-spinner").length ||
      ($("body").append(
        `<style>.spinner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 9999; } .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style><div id="loading-spinner" class="spinner-overlay"><div class="spinner"></div></div>`
      ),
      $("#wc-cepta-form").show());
  }
  function f() {
    $("#loading-spinner").remove();
  }
  function g(a) {
    e();
    const b = wc_cepta_params.meta_order_id,
      c = wc_cepta_params.nonce,
      g = "/wc-api/wc_gateway_cepta_popup";
    $.ajax({
      url: g,
      method: "POST",
      data: { transactionRef: a, ceptaOderId: b, wc_cepta_payment_nonce: c },
      dataType: "json",
      success: function (a) {
        let c = wc_cepta_params.checkout_url;
        wc_cepta_params.hasOwnProperty("return_url")
          ? (c = wc_cepta_params.return_url)
          : (c = window.location.href.replace(
              /\/checkout\/order-pay\/\d+\/.*/,
              ""
            )),
          !0 === a.statusRes
            ? d(
                `Your payment for order #${b} is successful and confirmed! Click OK to proceed.`,
                c
              )
            : d(
                `Your payment for order #${b} has failed. Please try again.`,
                c
              );
      },
      error: function (a, c, e) {
        console.error("Verification AJAX Error:", c, e),
          d(
            `An unexpected error occurred during verification. Please contact support.`,
            wc_cepta_params.checkout_url || window.location.href
          );
      },
      complete: function () {
        f();
      },
    });
  }
  async function h() {
    $("#wc-cepta-form").hide(),
      $("form#payment-form, form#order_review")
        .find("input.cepta_txnref")
        .val("");
    const a = Number(wc_cepta_params.amount),
      d = window.location.href,
      e = "WC_" + Date.now(),
      f = b(),
      h = {
        amount: a,
        currency: wc_cepta_params.currency,
        description: "Payment for Order ID " + wc_cepta_params.meta_order_id,
        pageName: "",
        customerEmail: wc_cepta_params.email,
        transactionReference: e,
        customUrlText: "",
        callbackUrl: d + "&nonce=" + encodeURIComponent(wc_cepta_params.nonce),
        isPlugin: !0,
      },
      i = {
        publicKey: wc_cepta_params.public_key,
        secretKey: wc_cepta_params.secret_key,
        baseUrl: wc_cepta_params.base_url,
      };
    function j(a) {
      $("form#payment-form, form#order_review")
        .find("input.cepta_txnref")
        .val(a),
        $("form.checkout, form#order_review").submit();
    }
    function k(a) {
      console.error("CeptaPay Payment Failed. Ref:", a),
        $("#wc-cepta-form").show();
    }
    function l(a) {
      console.warn(
        "CeptaPay Modal Closed by User. Initiating verification (status check)..."
      ),
        g(a);
    }
    let m = new URLSearchParams(window.location.search).get("TransactionRef");
    if (
      (m ||
        (m = (function () {
          const a = d.lastIndexOf("?");
          if (-1 !== a) {
            const b = d.substring(a + 1).split("&");
            for (let a = 0; a < b.length; a++) {
              const c = b[a].split("=");
              if ("TransactionRef" === c[0]) return c[1];
            }
          }
          return null;
        })()),
      m)
    ) {
      console.log(
        "Found transaction reference in URL. Initiating verification..."
      ),
        g(m);
    } else {
      if (
        "undefined" == typeof window.CeptaPay ||
        "function" != typeof window.CeptaPay.checkout
      )
        return (
          console.error(
            "CeptaPay SDK is not loaded. Cannot proceed with payment."
          ),
          void k(h.transactionReference)
        );
      try {
        window.CeptaPay.checkout({
          paymentData: h,
          config: i,
          onSuccess: j,
          onFailed: k,
          onClose: l,
        });
      } catch (a) {
        console.error("CeptaPay Checkout failed to launch:", a.message),
          k(h.transactionReference);
      }
    }
  }
  $("form.checkout").on("checkout_place_order_cepta", function (a) {
    return a.preventDefault(), h(), !1;
  }),
    $("#order_review").on("submit", function (a) {
      if ($("#payment_method_cepta").is(":checked"))
        return a.preventDefault(), h(), !1;
    }),
    $("#cepta-payment-button").length &&
      $("#cepta-payment-button").on("click", function (a) {
        return a.preventDefault(), h(), !1;
      }),
    $("#wc-cepta-form").hide(),
    h(),
    $("#cepta_form form#order_review").submit(function () {
      handlePayment();
    }),
    "true" === wc_cepta_params.is_order_pay_page && h();
});
